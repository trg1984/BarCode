/**
 * Code39
 * Copyright © Rolf Lindén (rolind@utu.fi) 2021
 * Original data from https://en.wikipedia.org/wiki/Code_39 and
 * https://fr.wikipedia.org/wiki/Code_39.
 */
Code39 = {
    bars: [
        "A", "100001001",
        "B", "001001001",
        "C", "101001000",
        "D", "000011001",
        "E", "100011000",
        "F", "001011000",
        "G", "000001101",
        "H", "100001100",
        "I", "001001100",
        "J", "000011100",
        "K", "100000011",
        "L", "001000011",
        "M", "101000010",
        "N", "000010011",
        "O", "100010010",
        "P", "001010010",
        "Q", "000000111",
        "R", "100000110",
        "S", "001000110",
        "T", "000010110",
        "U", "110000001",
        "V", "011000001",
        "W", "111000000",
        "X", "010010001",
        "Y", "110010000",
        "Z", "011010000",
        "0", "000110100",
        "1", "100100001",
        "2", "001100001",
        "3", "101100000",
        "4", "000110001",
        "5", "100110000",
        "6", "001110000",
        "7", "000100101",
        "8", "100100100",
        "9", "001100100",
        " ", "011000100",
        "-", "010000101",
        "$", "010101000",
        "%", "000101010",
        ".", "110000100",
        "/", "010100010",
        "+", "010001010",
        "*", "010010100"
    ],
	conv: [
        "0","\u0000","%U",
        "1","\u0001","$A",
        "2","\u0002","$B",
        "3","\u0003","$C",
        "4","\u0004","$D",
        "5","\u0005","$E",
        "6","\u0006","$F",
        "7","\u0007","$G",
        "8","\u0008","$H",
        "9","\u0009","$I",
        "10","\u000a","$J",
        "11","\u000b","$K",
        "12","\u000c","$L",
        "13","\u000d","$M",
        "14","\u000e","$N",
        "15","\u000f","$O",
        "16","\u0010","$P",
        "17","\u0011","$Q",
        "18","\u0012","$R",
        "19","\u0013","$S",
        "20","\u0014","$T",
        "21","\u0015","$U",
        "22","\u0016","$V",
        "23","\u0017","$W",
        "24","\u0018","$X",
        "25","\u0019","$Y",
        "26","\u001a","$Z",
        "27","\u001b","%A",
        "28","\u001c","%B",
        "29","\u001d","%C",
        "30","\u001e","%D",
        "31","\u001f","%E",
        "32"," "," ",
        "33","!","/A",
        "34",'"',"/B",
        "35","#","/C",
        "36","$","/D",
        "37","%","/E",
        "38","&","/F",
        "39","'","/G",
        "40","(","/H",
        "41",")","/I",
        "42","*","/J",
        "43","+","/K",
        "44",",","/L",
        "45","-","-",
        "46",".",".",
        "47","/","/O",
        "48","0","0",
        "49","1","1",
        "50","2","2",
        "51","3","3",
        "52","4","4",
        "53","5","5",
        "54","6","6",
        "55","7","7",
        "56","8","8",
        "57","9","9",
        "58",":","/Z",
        "59",";","%F",
        "60","<","%G",
        "61","=","%H",
        "62",">","%I",
        "63","?","%J",
        "64","@","%V",
        "65","A","A",
        "66","B","B",
        "67","C","C",
        "68","D","D",
        "69","E","E",
        "70","F","F",
        "71","G","G",
        "72","H","H",
        "73","I","I",
        "74","J","J",
        "75","K","K",
        "76","L","L",
        "77","M","M",
        "78","N","N",
        "79","O","O",
        "80","P","P",
        "81","Q","Q",
        "82","R","R",
        "83","S","S",
        "84","T","T",
        "85","U","U",
        "86","V","V",
        "87","W","W",
        "88","X","X",
        "89","Y","Y",
        "90","Z","Z",
        "91","[","%K",
        "92","\\","%L",
        "93","]","%M",
        "94","^","%N",
        "95","_","%O",
        "96","`","%W",
        "97","a","+A",
        "98","b","+B",
        "99","c","+C",
        "100","d","+D",
        "101","e","+E",
        "102","f","+F",
        "103","g","+G",
        "104","h","+H",
        "105","i","+I",
        "106","j","+J",
        "107","k","+K",
        "108","l","+L",
        "109","m","+M",
        "110","n","+N",
        "111","o","+O",
        "112","p","+P",
        "113","q","+Q",
        "114","r","+R",
        "115","s","+S",
        "116","t","+T",
        "117","u","+U",
        "118","v","+V",
        "119","w","+W",
        "120","x","+X",
        "121","y","+Y",
        "122","z","+Z",
        "123","{","%P",
        "124","|","%Q",
        "125","}","%R",
        "126","~","%S",
        "127","\u007f","%T",
        "127","\u007f","%X",
        "127","\u007f","%Y",
        "127","\u007f","%Z"
    ],
    binToBars: function(bin) {
        
        a = bin.split('');
        var b = [], prev = '', count = 0;
        for (i in a) b.push((a[i]|0) + 1);
        return b;
    },
    binToCountBars: function(bin) {
        
        a = bin.split('');
        var b = [], prev = '', count = 0;
        for (i in a) {
            if (a[i] === prev) ++count;
            else {
                b.push(count);
                prev = a[i];
                count = 1;
            }
        };
        b.push(count);
        return b.splice(1);
    },
    charToBars: function(c) {
        var self = this;
        var s = this.conv[this.conv.filter(function(item, index) { return index % 3 === 1 }).indexOf(c) * 3 + 2];
        
        var arr = s.split('').map(function(item1) {
            return self.bars[self.bars.filter(function(item2, index2) { return index2 % 2 === 0 }).indexOf(item1) * 2 + 1];
        }).map(this.binToBars);

        // Add spaces between multipart characters.
        if (arr.length > 1)for (var i = 0; i < arr.length -1; ++i) arr[i].push(1);

        return arr.flat();
    }
}